---
title: "Cell Image Gallery"
format:
  html:
    css: styles.css
---

Explore our collection of forensic cell images organized by category. Click any image to view it in full size.

---

<section id="sample-images-section" class="gallery-section">

## Sample Images {.section-header}
<p class="section-description">Explore and experiment with pre-loaded cell images.</p>


<article id="buccal-cells-section" class="cell-type-section">

### Buccal Cells {.subsection-header}

<div id="buccal-loading" class="loading">Loading buccal cell images...</div>
<div id="buccal-error" class="error" style="display: none;"></div>
<div id="buccal-gallery" class="gallery-grid"></div>

</article>

<article id="epidermal-cells-section" class="cell-type-section">

### Epidermal Cells {.subsection-header}

<div id="epidermal-loading" class="loading">Loading epidermal cell images...</div>
<div id="epidermal-error" class="error" style="display: none;"></div>
<div id="epidermal-gallery" class="gallery-grid"></div>

</article>

<article id="saliva-cells-section" class="cell-type-section">

### Saliva Cells {.subsection-header}

<div id="saliva-loading" class="loading">Loading saliva cell images...</div>
<div id="saliva-error" class="error" style="display: none;"></div>
<div id="saliva-gallery" class="gallery-grid"></div>

</article>

</section>

---

<section id="uploaded-images-section" class="gallery-section">

## Uploaded Images {.section-header}

<p class="section-description">Images you've uploaded.</p>

<div id="uploaded-loading" class="loading">Loading uploaded images...</div>
<div id="uploaded-error" class="error" style="display: none;"></div>
<div id="uploaded-gallery" class="gallery-grid"></div>

:::{.callout-note}
Upload your own cell images using the Upload Tool to add them to this gallery for analysis.
:::

</section>

---

<section id="processed-images-section" class="gallery-section">

## Processed Images {.section-header}

<p class="section-description">Images that have been analyzed and processed using our segmentation and identification tools.</p>

<div id="processed-loading" class="loading">Loading processed images...</div>
<div id="processed-error" class="error" style="display: none;"></div>
<div id="processed-gallery" class="gallery-grid"></div>

:::{.callout-tip}
Processed images will appear here after images have been analyzed and processed.
:::

</section>

<script>
const API_BASE_URL = '/api'; 

// creates an image element with processing controls
function createImageElement(src, alt = 'Cell image', canProcess = false) {
  const container = document.createElement('div');
  container.className = 'image-container';
  
  const img = document.createElement('img');
  img.src = src;
  img.alt = alt;
  img.className = 'gallery-image';
  img.loading = 'lazy';
  
  img.addEventListener('error', () => {
    img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="250" height="250"%3E%3Crect fill="%23ddd" width="250" height="250"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EImage not found%3C/text%3E%3C/svg%3E';
  });
  
  container.appendChild(img);
  
  // Add overlay with buttons if image can be processed
  if (canProcess) {
    const overlay = document.createElement('div');
    overlay.className = 'image-overlay';
    
    const processBtn = document.createElement('button');
    processBtn.className = 'btn-process';
    processBtn.textContent = 'Process';
    processBtn.onclick = () => processImage(src, container);
    
    const viewBtn = document.createElement('button');
    viewBtn.className = 'btn-view';
    viewBtn.textContent = 'View';
    viewBtn.onclick = () => window.open(src, '_blank');
    
    overlay.appendChild(processBtn);
    overlay.appendChild(viewBtn);
    container.appendChild(overlay);
  }
  
  return container;
}

// creates an image element for processed images with compare functionality
function createProcessedImageElement(src, alt = 'Processed image') {
  const container = document.createElement('div');
  container.className = 'image-container';
  
  const img = document.createElement('img');
  img.src = src;
  img.alt = alt;
  img.className = 'gallery-image';
  img.loading = 'lazy';
  
  img.addEventListener('error', () => {
    img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="250" height="250"%3E%3Crect fill="%23ddd" width="250" height="250"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" text-anchor="middle" dy=".3em"%3EImage not found%3C/text%3E%3C/svg%3E';
  });
  
  container.appendChild(img);
  
  // Add overlay with Compare button
  const overlay = document.createElement('div');
  overlay.className = 'image-overlay';
  
  const compareBtn = document.createElement('button');
  compareBtn.className = 'btn-view'; // reuse existing style
  compareBtn.textContent = 'Compare';
  compareBtn.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    showComparisonModal(src);
  };
  
  overlay.appendChild(compareBtn);
  container.appendChild(overlay);
  
  return container;
}

// TODO: extract css to styles

// Show modal with original and processed images side by side
function showComparisonModal(processedSrc) {
  // Extract the filename from the processed image path
  const filename = processedSrc.split('/').pop();
  
  // Get original filename by removing 'processed_' prefix
  const originalFilename = filename.replace(/^processed_/, '');
  
  // Construct original image path
  const originalSrc = processedSrc
    .replace('/processed-images/', '/uploaded-images/')
    .replace(filename, originalFilename);
  
  // Create modal backdrop
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    padding: 20px;
  `;
  
  // Create modal content
  const content = document.createElement('div');
  content.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 30px;
    max-width: 1400px;
    width: 100%;
    max-height: 90vh;
    overflow: auto;
    position: relative;
  `;
  
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '×';
  closeBtn.style.cssText = `
    position: absolute;
    top: 15px;
    right: 15px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 28px;
    cursor: pointer;
    line-height: 1;
    z-index: 10;
  `;
  closeBtn.onclick = () => {
    document.body.style.overflow = '';
    modal.remove();
  };
  
  // Container for images
  const imagesContainer = document.createElement('div');
  imagesContainer.style.cssText = `
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
  `;
  
  // Original image section
  const originalSection = document.createElement('div');
  originalSection.style.cssText = 'text-align: center;';
  
  const originalTitle = document.createElement('h3');
  originalTitle.textContent = 'Original Image';
  originalTitle.style.cssText = 'color: #2c3e50; margin-bottom: 15px; font-size: 1.5rem;';
  
  const originalImg = document.createElement('img');
  originalImg.src = originalSrc;
  originalImg.style.cssText = `
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  originalSection.appendChild(originalTitle);
  originalSection.appendChild(originalImg);
  
  // Processed image section
  const processedSection = document.createElement('div');
  processedSection.style.cssText = 'text-align: center;';
  
  const processedTitle = document.createElement('h3');
  processedTitle.textContent = 'Processed Image';
  processedTitle.style.cssText = 'color: #2c3e50; margin-bottom: 15px; font-size: 1.5rem;';
  
  const processedImg = document.createElement('img');
  processedImg.src = processedSrc;
  processedImg.style.cssText = `
    width: 100%;
    height: auto;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  processedSection.appendChild(processedTitle);
  processedSection.appendChild(processedImg);
  
  // Assemble everything
  imagesContainer.appendChild(originalSection);
  imagesContainer.appendChild(processedSection);
  
  content.appendChild(closeBtn);
  content.appendChild(imagesContainer);
  modal.appendChild(content);
  
  // Close on backdrop click
  modal.onclick = (e) => {
    if (e.target === modal) {
      document.body.style.overflow = '';
      modal.remove();
    }
  };
  
  // Add to page
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

async function processImage(imageSrc, containerElement) {
  const processBtn = containerElement.querySelector('.btn-process');
  const originalText = processBtn.textContent;
  
  try {
    // Show processing status
    processBtn.disabled = true;
    processBtn.textContent = 'Processing...';
    
    // Add processing indicator
    const statusDiv = document.createElement('div');
    statusDiv.className = 'processing-status';
    statusDiv.textContent = 'Processing...';
    containerElement.appendChild(statusDiv);
    
    // Fetch the image as a blob
    const imageResponse = await fetch(imageSrc);
    if (!imageResponse.ok) throw new Error('Failed to fetch image');
    
    const imageBlob = await imageResponse.blob();
    
    const filename = imageSrc.split('/').pop();
    
    // Create FormData and send to processing endpoint
    const formData = new FormData();
    formData.append('image', imageBlob, filename);
    
    const response = await fetch(`${API_BASE_URL}/process-img`, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) throw new Error('Failed to process image');
    
    const data = await response.json();
    
    // success
    statusDiv.textContent = 'Processed ✓';
    statusDiv.style.backgroundColor = 'rgba(46, 204, 113, 0.9)';
    
    setTimeout(() => {
      statusDiv.remove();
      processBtn.disabled = false;
      processBtn.textContent = originalText;
      
      loadProcessedImages();
      
      alert(`Image processed successfully! View it in the Processed Images section below.`);
    }, 2000);
    
  } catch (error) {
    console.error('Error processing image:', error);
    
    // Remove status if exists
    const statusDiv = containerElement.querySelector('.processing-status');
    if (statusDiv) statusDiv.remove();
    
    processBtn.disabled = false;
    processBtn.textContent = originalText;
    
    alert(`Failed to process image: ${error.message}`);
  }
}

function showError(errorElementId, message) {
  const loadingEl = document.getElementById(errorElementId.replace('-error', '-loading'));
  const errorEl = document.getElementById(errorElementId);
  
  if (loadingEl) loadingEl.style.display = 'none';
  if (errorEl) {
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }
}

function hideLoading(loadingElementId) {
  const loadingEl = document.getElementById(loadingElementId);
  if (loadingEl) loadingEl.style.display = 'none';
}

function populateGallery(galleryId, images, altPrefix = 'Cell image', canProcess = false, useProcessedElement = false) {
  const gallery = document.getElementById(galleryId);
  if (!gallery) return;
  
  if (images.length === 0) {
    gallery.innerHTML = '<div class="empty-gallery">No images available</div>';
  } else {
    gallery.innerHTML = '';
    images.forEach((src, index) => {
      const element = useProcessedElement 
        ? createProcessedImageElement(src, `${altPrefix} ${index + 1}`)
        : createImageElement(src, `${altPrefix} ${index + 1}`, canProcess);
      gallery.appendChild(element);
    });
  }
}

async function loadSampleImages() {
  try {
    const response = await fetch(`${API_BASE_URL}/gallery/sample-images`);
    if (!response.ok) throw new Error('Failed to fetch sample images');
    
    const data = await response.json();
    
    // Populate each cell type gallery with processing enabled
    hideLoading('buccal-loading');
    populateGallery('buccal-gallery', data.buccal_cells || [], 'Buccal cell', true);
    
    hideLoading('epidermal-loading');
    populateGallery('epidermal-gallery', data.epidermal_cells || [], 'Epidermal cell', true);
    
    hideLoading('saliva-loading');
    populateGallery('saliva-gallery', data.saliva_cells || [], 'Saliva cell', true);
    
  } catch (error) {
    console.error('Error loading sample images:', error);
    showError('buccal-error', 'Failed to load buccal cell images');
    showError('epidermal-error', 'Failed to load epidermal cell images');
    showError('saliva-error', 'Failed to load saliva cell images');
  }
}

async function loadUploadedImages() {
  try {
    const response = await fetch(`${API_BASE_URL}/gallery/uploaded-images`);
    if (!response.ok) throw new Error('Failed to fetch uploaded images');
    
    const data = await response.json();
    hideLoading('uploaded-loading');
    // Enable processing for uploaded images
    populateGallery('uploaded-gallery', data.images || [], 'Uploaded image', true);
    
  } catch (error) {
    console.error('Error loading uploaded images:', error);
    showError('uploaded-error', 'Failed to load uploaded images');
  }
}

async function loadProcessedImages() {
  try {
    const response = await fetch(`${API_BASE_URL}/gallery/processed-images`);
    if (!response.ok) throw new Error('Failed to fetch processed images');
    
    const data = await response.json();
    hideLoading('processed-loading');
    // Use special processed image elements with Compare button
    populateGallery('processed-gallery', data.images || [], 'Processed image', false, true);
    
  } catch (error) {
    console.error('Error loading processed images:', error);
    showError('processed-error', 'Failed to load processed images');
  }
}

// Load all galleries when page loads
document.addEventListener('DOMContentLoaded', () => {
  loadSampleImages();
  loadUploadedImages();
  loadProcessedImages();
});
</script>